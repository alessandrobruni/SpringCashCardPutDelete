# SpringCashCardPutDelete

<div class="max-w-container mx-auto">
        <div class="xl:grid grid-cols-3 gap-12">
            <div class="rich-text col-span-2">
                <h1>Implementing PUT</h1>

                                    
<p>So far we&rsquo;re able to create and retrieve Cash Cards. A next logical step is the ability to adjust a card balance! How to implement the Update operation in a RESTful API is somewhat of a hot topic, which is what we&rsquo;ll tackle in this lesson.</p>
<p>When we say &ldquo;adjust the balance&rdquo; on a Cash Card, what we really mean is to update the <code>amount</code> on an existing database record. Doing so will entail:</p>
<ul><li>Creating a new endpoint to receive an HTTP request with a verb, URI, and body</li>
<li>Returning an appropriate response from the endpoint for success and error conditions</li>
</ul><p>We&rsquo;re already familiar with the HTTP <code>POST</code> verb, which we used for the Create endpoint. Now let's talk about HTTP <code>PUT</code> and <code>PATCH</code>, and how all three of these are related.</p>
<h2 id="put-and-patch" class="anchored"><a href="#put-and-patch" class="anchor" role="button"></a>PUT and PATCH</h2>
<p>Both <code>PUT</code> and <code>PATCH</code> can be used for updating, but they work in different ways. Essentially, <code>PUT</code> means &ldquo;create or replace the complete record&rdquo;, whereas <code>PATCH</code> means &ldquo;update only some fields of the existing record&rdquo; - in other words, a partial update.</p>
<p>Why would you want to do a partial update? Partial updates free the client from having to load the entire record and then transmit the entire record back to the server. If the record is large enough, this can have a non-trivial impact on performance.</p>
<p>For our application, we&rsquo;ll choose to <strong>not</strong> implement a partial update.</p>
<h2 id="put-and-post" class="anchored"><a href="#put-and-post" class="anchor" role="button"></a>PUT and POST</h2>
<p>There&rsquo;s something we didn&rsquo;t tell you when we wrote the Create endpoint: The HTTP standard does not specify whether the <code>POST</code> or <code>PUT</code> verb is preferred for a Create operation! This is relevant because we&rsquo;ll use the <code>PUT</code> verb for our Update endpoint, so we need to decide whether our API will support using <code>PUT</code> to either Create <em>or</em> Update a resource.</p>
<p>There are different ways to look at the relationship between the <strong>Create</strong> and <strong>Update</strong> operations and how they are implemented in REST using HTTP verbs. In the following sections we discuss it from three different points of view, then summarize what we've covered so far, as a table.</p>
<p>The important takeaway from the following sections is not to memorize all the details, but simply to realize that there are lots of different choices, and that we, as Cash Card API authors, are consciously making decisions about how to implement REST.</p>
<h3>Surrogate and Natural Keys</h3>
<p>Why would we want to use a <code>PUT</code> operation to create a resource? This has to do with the HTTP definition of the two verbs. The difference is subtle. Let&rsquo;s explain it by comparing two different systems: Our <strong>Cash Card API</strong>, and another API that we'll introduce for explanatory purposes, called the <strong>Invoice API</strong>. The Invoice API accepts the Invoice Number as the unique identifier. This is an example of using a <strong>Natural Key</strong> (supplied by the client to the API) instead of a <strong>Surrogate Key</strong> (usually generated by the server, which is what we are doing in our Cash Card API).</p>
<p>The important difference is <strong>whether the URI (which includes the ID of the resource) needs to be generated by the server</strong> or not. Here is how PUT and POST think about it:</p>
<ol><li>If you need the server to return the URI of the created resource (or the data you use to construct the URI), then you must use <code>POST</code>.</li>
</ol><p>This is the case for our Cash Card API: To create a Cash Card, we provide the <code>POST /cashcards</code> endpoint. The actual URI for the created Cash Card depends on the generated ID, and is provided by the server, for example, <code>/cashcards/101</code> if the ID of the created card is 101.</p>
<ol><li>Alternatively, when the resource URI is known at creation time (as is the case in our example Invoice API), you can use <code>PUT</code>.</li>
</ol><p>For the Invoice API, we could write a Create endpoint that accepts requests such as <code>PUT /invoice/1234-567</code>. The corresponding Read call would use the exact same URI: <code>GET /invoice/1234-567</code>.</p>
<h3>Resources and Sub-Resources</h3>
<p>Another way to look at the difference is in terms of <strong>URIs and collections of sub-resources</strong>. This is the language used by the HTTP documentation, so it's good to be familiar with it. Following the above examples, we&rsquo;d find:</p>
<ul><li><p><strong><code>POST</code> creates a sub-resource (child resource) <em>under (after)</em>, or <em>within</em> the request URI</strong>. This is what the Cash Card API does: The client calls the Create endpoint at <code>POST /cashcards</code>, but the actual URI of the created resource contains a generated ID at the end: <code>/cashcards/101</code></p>
</li>
<li><p><strong><code>PUT</code> creates or replaces (updates) a resource <em>at a specific</em> request URI</strong>. For the <code>/invoice</code> example above, the Create endpoint would be <code>PUT /invoice/1234-567</code>, and the URI of the created resource would be the same as the URI sent in the <code>PUT</code> request.</p>
</li>
</ul><h3>Response Body and Status Code</h3>
<p>Related to deciding whether to allow <code>PUT</code> to create objects, you need to decide what the response status code and body should be. Two different options are:</p>
<ul><li>Return <code>201 CREATED</code> (if you created the object), or <code>200 OK</code> (if you replaced an existing object). In this case it's recommended to return the object in the response body. This is useful if data was added to the object by the server (for example, if the server records the creation date).</li>
</ul><p><em>or</em></p>
<ul><li>Return <code>204 NO CONTENT</code>, and an empty response body. The rationale in this case is that since a <code>PUT</code> simply places on object at the URI in the request, the client doesn't need any information back - it knows that the object in the request has been saved, verbatim, on the server.</li>
</ul><h2 id="post-put-patch-and-crud-operations-summary" class="anchored"><a href="#post-put-patch-and-crud-operations-summary" class="anchor" role="button"></a>POST, PUT, PATCH and CRUD Operations - Summary</h2>
<p>The sections above can be summarized using the following table:</p>
<table><thead><tr><th>HTTP Method</th><th>Operation</th><th>Definition of Resource URI</th><th>What does it do?</th><th>Response Status Code</th><th>Response Body</th></tr></thead><tbody><tr><td><strong><code>POST</code></strong></td><td><strong>Create</strong></td><td><strong>Server generates and returns the URI</strong></td><td><strong>Creates a sub-resource ("under" or "within" the passed URI)</strong></td><td><strong><code>201 CREATED</code></strong></td><td><strong>The created resource</strong></td></tr><tr><td><code>PUT</code></td><td>Create</td><td>Client supplies the URI</td><td>Creates a resource (at the Request URI)</td><td><code>201 CREATED</code></td><td>The created resource</td></tr><tr><td><strong><code>PUT</code></strong></td><td><strong>Update</strong></td><td><strong>Client supplies the URI</strong></td><td><strong>Replaces the resource: The entire record is replaced by the object in the Request</strong></td><td><strong><code>204 NO CONTENT</code></strong></td><td><strong>(empty)</strong></td></tr><tr><td><code>PATCH</code></td><td>Update</td><td>Client supplies the URI</td><td>Partial Update: modify only fields included in the request on the existing record</td><td><code>200 OK</code></td><td>The updated resource</td></tr></tbody></table><p>In the Cash Card API, we don&rsquo;t need to allow <code>PUT</code> to create resources. We also have no need to add data on the server side for an Update operation, nor do we need to allow for partial update. So, our <code>PUT</code> endpoint is limited to row 3 of the above table.</p>
<p>The <strong>bold</strong> rows in the above table are implemented by Cash Card API. The non-bold ones are not.</p>
<h2 id="security" class="anchored"><a href="#security" class="anchor" role="button"></a>Security</h2>
<p>One more decision we&rsquo;ll make is how to apply security logic to the new Update operation.</p>
<p>Recall from the Simple Security lesson that we decided to return <code>404 NOT FOUND</code> for <code>GET</code> requests in two cases: nonexistent IDs, and attempted access to cards for which the user isn&rsquo;t authorized. We&rsquo;ll use the same strategy for the Update endpoint, and for similar reasons (we&rsquo;ll go into more details in the lab).</p>
<h2 id="our-api-decisions" class="anchored"><a href="#our-api-decisions" class="anchor" role="button"></a>Our API Decisions</h2>
<p>Phew, that was a lot of decisions! To summarize, we decided:</p>
<ul><li><code>PUT</code> won&rsquo;t support creating a Cash Card.</li>
<li>Our new <strong>Update</strong> endpoint (which we'll build in the upcoming Lab):<ul><li>will use the <code>PUT</code> verb.</li>
<li>accepts a Cash Card, and <strong>replaces</strong> the existing Cash Card with it.</li>
<li>on success, will return <code>204 NO CONTENT</code> with an empty body.</li>
<li>will return a <code>404 NOT FOUND</code> for an unauthorized update, as well as attempts to update nonexistent IDs.</li>
</ul></li>
</ul>




<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-oqvxew" data-session-namespace="spring-academy-w08-s450" data-workshop-namespace="spring-academy-w08" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="01-overview" data-current-page="02-write-the-test" data-next-page="03-implement-putmapping" data-page-format="markdown" data-page-step="2" data-pages-total="6"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="01-overview" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="03-implement-putmapping" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">2: Write the Test First</h1><div class="rendered-content"><p>As we have in almost every lab, let&#39;s begin with a test.</p>
<p>What is the functionality we want our application to have? How do we want our application to behave?</p>
<p>Let&#39;s define this now, and then work our way towards satisfying our aspirations.</p>
<ol>
<li><p>Write the Update test.</p>
<p>We will use <code>PUT</code> to update <code>CashCards</code>.</p>
<p>Note that we&#39;ll expect a <code>204 NO_CONTENT</code> response instead of a <code>200 OK</code>. The <code>204</code> indicates that the action was successfully performed and no further action is needed by the caller.</p>
<p>Edit <code>src/test/java/example/cashcard/CashCardApplicationTests.java</code> and add the following test, which updates Cash Card <code>99</code> and sets its <code>amount</code> to <code>19.99</code>.</p>
<p>Don&#39;t forget to add the two new imports.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">import</span> org.springframework.http.HttpEntity;
<span class="hljs-keyword">import</span> org.springframework.http.HttpMethod;
...
<span class="hljs-meta">@Test</span>
<span class="hljs-meta">@DirtiesContext</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldUpdateAnExistingCashCard</span><span class="hljs-params">()</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCardUpdate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CashCard</span>(<span class="hljs-literal">null</span>, <span class="hljs-number">19.99</span>, <span class="hljs-literal">null</span>);
    HttpEntity&lt;CashCard&gt; request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>&lt;&gt;(cashCardUpdate);
    ResponseEntity&lt;Void&gt; response = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .exchange(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, HttpMethod.PUT, request, Void.class);
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);
}
</code></pre>
<h3 id="learning-moment-whats-up-with-resttemplateexchange">Learning Moment: what&#39;s up with <code>restTemplate.exchange()</code>?</h3>
<p>Did you notice that we&#39;re not using <code>RestTemplate</code> in the same way we have in our previous tests?</p>
<p>All other tests use <code>RestTemplate.xyzForEntity()</code> methods such as <code>getForEntity()</code> and <code>postForEntity()</code>.</p>
<p>So, why are we not following the same pattern utilizing <code>putForEntity()</code>?</p>
<p>Answer: <code>putForEntity()</code> does not exist! Read more about it here in the <a href="https://github.com/spring-projects/spring-framework/issues/15256">GitHub issue</a> about the topic.</p>
<p>Luckily <code>RestTemplate</code> supports multiple ways of interacting with REST APIs, such as <code>RestTemplate.exchange()</code>.</p>
<p>Let&#39;s learn about <code>RestTemplate.exchange()</code> now.</p>
</li>
<li><p>Understand <code>RestTemplate.exchange()</code>.</p>
<p>Let&#39;s understand more about what&#39;s happening.</p>
<p>The <code>exchange()</code> method is a more general version of the <code>xyzForEntity()</code> methods we&#39;ve used in other tests: <code>exchange()</code> requires the verb and the request entity (the body of the request) to be supplied as parameters.</p>
<p>Using <code>getForEntity()</code> as an example, you can imagine that the following two lines of code accomplish the same goal:</p>
<p><code>.exchange(&quot;/cashcards/99&quot;, HttpMethod.GET, new HttpEntity(null), String.class);</code></p>
<p>The above line is functionally equivalent to the following line:</p>
<p><code>.getForEntity(&quot;/cashcards/99&quot;, String.class);</code></p>
<p>Now let&#39;s explain the test code.</p>
<ul>
<li><p>First we create the <code>HttpEntity</code> that the <code>exchange()</code> method needs:</p>
<pre><code class="hljs language-java">HttpEntity&lt;CashCard&gt; request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>&lt;&gt;(existingCashCard);
</code></pre>
</li>
<li><p>Then we call <code>exchange()</code>, which sends a <code>PUT</code> request for the target ID of <code>99</code> and updated Cash Card data:</p>
<pre><code class="hljs language-java">.exchange(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, HttpMethod.PUT, request, Void.class);
</code></pre>
</li>
</ul>
</li>
<li><p>Run the tests.</p>
<p>It&#39;s time to watch our tests <em>fail for the right reasons.</em></p>
<p>For what reason will our new test fail?</p>
<p>Note that we&#39;ll always use <code>./gradlew test</code> to run our tests.</p>
<pre><code class="hljs language-shell">[~/exercises] $ ./gradlew test
...
CashCardApplicationTests &gt; shouldUpdateAnExistingCashCard() FAILED
 org.opentest4j.AssertionFailedError:
 expected: 204 NO_CONTENT
  but was: 403 FORBIDDEN
...
BUILD FAILED in 6s
</code></pre>
<p>Answer: we haven&#39;t implemented a <code>PUT</code> request method handler yet!</p>
<p>As you can see, the test failed with a <code>403 FORBIDDEN</code> response code.</p>
<p>With no Controller endpoint, this <code>PUT</code> call is forbidden! Spring Security automatically handled this scenario for us.</p>
</li>
</ol>
<p>Next, let&#39;s implement the Controller endpoint.</p>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="03-implement-putmapping" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w08-s450/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page active"><a href="/workshop/content/02-write-the-test">2: Write the Test First</a></li><li class="page"><a href="/workshop/content/03-implement-putmapping">3: Implement @PutMapping in the Controller</a></li><li class="page"><a href="/workshop/content/04-test-security">4: Additional Testing and Spring Security's Influence</a></li><li class="page"><a href="/workshop/content/05-refactor">5: Refactor the Controller Code</a></li><li class="page"><a href="/workshop/content/10-summary">6: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary"
<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-oqvxew" data-session-namespace="spring-academy-w08-s450" data-workshop-namespace="spring-academy-w08" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="02-write-the-test" data-current-page="03-implement-putmapping" data-next-page="04-test-security" data-page-format="markdown" data-page-step="3" data-pages-total="6"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="02-write-the-test" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="04-test-security" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">3: Implement @PutMapping in the Controller</h1><div class="rendered-content"><p>Following the pattern we&#39;ve used this far in our Controller, let&#39;s implement the <code>PUT</code> endpoint in our <code>CashCardController</code>.</p>
<ol>
<li><p>Add a minimal <code>@PutMapping</code>.</p>
<p>Edit <code>src/main/java/example/cashcard/CashCardController.java</code> and add the <code>PUT</code> endpoint.</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@PutMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">putCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, <span class="hljs-meta">@RequestBody</span> CashCard cashCardUpdate)</span> {
    <span class="hljs-comment">// just return 204 NO CONTENT for now.</span>
    <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
}
</code></pre>
<p>This Controller endpoint is fairly self-explanatory:</p>
<ul>
<li>The <code>@PutMapping</code> supports the <code>PUT</code> verb and supplies the target <code>requestedId</code>.</li>
<li>The <code>@RequestBody</code> contains the updated <code>CashCard</code> data.</li>
<li>Return an HTTP <code>204 NO_CONTENT</code> response code for now just to get started.</li>
</ul>
</li>
<li><p>Run the tests.</p>
<p>What do you think will happen?</p>
<p>Let&#39;s run them now.</p>
<pre><code class="hljs language-shell">...
CashCardApplicationTests &gt; shouldUpdateAnExistingCashCard() PASSED
...
BUILD SUCCESSFUL in 6s
</code></pre>
<p>They pass!</p>
<p>But, that isn&#39;t very satisfying, is it?</p>
<p>We haven&#39;t updated the <code>CashCard</code>!</p>
<p>Let&#39;s do that next.</p>
</li>
<li><p>Enhance the test to verify a successful update.</p>
<p>Similar to other verifications we&#39;ve performed in our test suite, let&#39;s assert that the update was successful.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldUpdateAnExistingCashCard</span><span class="hljs-params">()</span> {
  ...
  assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

  ResponseEntity&lt;String&gt; getResponse = restTemplate
          .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
          .getForEntity(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, String.class);
  assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
  <span class="hljs-type">DocumentContext</span> <span class="hljs-variable">documentContext</span> <span class="hljs-operator">=</span> JsonPath.parse(getResponse.getBody());
  <span class="hljs-type">Number</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> documentContext.read(<span class="hljs-string">&quot;$.id&quot;</span>);
  <span class="hljs-type">Double</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> documentContext.read(<span class="hljs-string">&quot;$.amount&quot;</span>);
  assertThat(id).isEqualTo(<span class="hljs-number">99</span>);
  assertThat(amount).isEqualTo(<span class="hljs-number">19.99</span>);
}
</code></pre>
</li>
<li><p>Understand the test updates.</p>
<ul>
<li><pre><code class="hljs language-java">ResponseEntity&lt;String&gt; getResponse = restTemplate
    .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
    .getForEntity(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, String.class);
</code></pre>
<p>Here we fetch <code>CashCard</code> <code>99</code> again so we can verify that it was updated.</p>
</li>
<li><pre><code class="hljs language-java">...
assertThat(id).isEqualTo(<span class="hljs-number">99</span>);
assertThat(amount).isEqualTo(<span class="hljs-number">19.99</span>);
</code></pre>
<p>Next, we assert that we&#39;ve retrieved the correct <code>CashCard</code> -- <code>99</code> -- and that its <code>amount</code> was successfully updated to <code>19.99</code>.</p>
</li>
</ul>
</li>
<li><p>Run the tests.</p>
<p>Our expectations are legit, but we haven&#39;t updated the <code>CashCardController</code> to match.</p>
<p>The test should fail with valuable error messages, right?</p>
<p>Let&#39;s run the tests now.</p>
<pre><code class="hljs language-shell">CashCardApplicationTests &gt; shouldUpdateAnExistingCashCard() FAILED
 org.opentest4j.AssertionFailedError:
 expected: 19.99
  but was: 123.45
</code></pre>
<p>Excellent! We expect an amount of <code>19.99</code>, but without any changes we are still returning <code>123.45</code>.</p>
<p>Let&#39;s update the Controller.</p>
</li>
<li><p>Update <code>CashCardController</code> to perform the data update.</p>
<p>As with our other handler methods, let&#39;s ensure that we guarantee only the <code>CashCard</code> <code>owner</code> can perform the updates -- the logged-in <code>Principal</code> must be the same as the Cash Card <code>owner</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@PutMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">putCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, <span class="hljs-meta">@RequestBody</span> CashCard cashCardUpdate, Principal principal)</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCard</span> <span class="hljs-operator">=</span> cashCardRepository.findByIdAndOwner(requestedId, principal.getName());
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">updatedCashCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CashCard</span>(cashCard.id(), cashCardUpdate.amount(), principal.getName());
    cashCardRepository.save(updatedCashCard);
    <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
}
</code></pre>
</li>
<li><p>Understand the <code>CashCardController</code> updates.</p>
<p>We&#39;re following a similar pattern as in the <code>@PostMapping createCashCard()</code> endpoint.</p>
<ul>
<li><pre><code class="hljs language-java"><span class="hljs-meta">@PutMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">putCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, <span class="hljs-meta">@RequestBody</span> CashCard cashCardUpdate, Principal principal)</span> {
</code></pre>
<p>We&#39;ve added the <code>Principal</code> as a method argument, provided automatically by Spring Security.</p>
<p>Thanks once again, Spring Security!</p>
</li>
<li><pre><code class="hljs language-java">cashCardRepository.findByIdAndOwner(requestedId, principal.getName());
</code></pre>
<p>Here we scope our retrieval of the <code>CashCard</code> to the submitted <code>requestedId</code> and <code>Principal</code> (provided by Spring Security) to ensure only the authenticated, authorized <code>owner</code> may update this <code>CashCard</code>.</p>
</li>
<li><pre><code class="hljs language-java"><span class="hljs-type">CashCard</span> <span class="hljs-variable">updatedCashCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CashCard</span>(cashCard.id(), cashCardUpdate.amount(), principal.getName());
cashCardRepository.save(updatedCashCard);
</code></pre>
<p>Finally, build a <code>CashCard</code> with updated values and save it.</p>
</li>
</ul>
<p>That was a lot! Let&#39;s run the tests and assess where we&#39;re at.</p>
</li>
<li><p>Run the tests.</p>
<p>They pass!</p>
<pre><code class="hljs language-shell">...
CashCardApplicationTests &gt; shouldUpdateAnExistingCashCard() PASSED
...
BUILD SUCCESSFUL in 6s
</code></pre>
</li>
</ol>
<p>We&#39;ve successfully implemented updating a <code>CashCard</code>.</p>
<p>But what happens if we attempt to update a <code>CashCard</code> that does not exist?</p>
<p>Let&#39;s test that scenario next.</p>
</div>



<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-oqvxew" data-session-namespace="spring-academy-w08-s450" data-workshop-namespace="spring-academy-w08" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="03-implement-putmapping" data-current-page="04-test-security" data-next-page="05-refactor" data-page-format="markdown" data-page-step="4" data-pages-total="6"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="03-implement-putmapping" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="05-refactor" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">4: Additional Testing and Spring Security's Influence</h1><div class="rendered-content"><p>What would happen if we tried to update a Cash Card that doesn&#39;t exist?</p>
<p>Let&#39;s add a test and find out.</p>
<ol>
<li><p>Try to update a Cash Card that doesn&#39;t exist.</p>
<p>Add the following test to <code>CashCardApplicationTests</code>.</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldNotUpdateACashCardThatDoesNotExist</span><span class="hljs-params">()</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">unknownCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CashCard</span>(<span class="hljs-literal">null</span>, <span class="hljs-number">19.99</span>, <span class="hljs-literal">null</span>);
    HttpEntity&lt;CashCard&gt; request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>&lt;&gt;(unknownCard);
    ResponseEntity&lt;Void&gt; response = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .exchange(<span class="hljs-string">&quot;/cashcards/99999&quot;</span>, HttpMethod.PUT, request, Void.class);
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
}
</code></pre>
<p>Here we&#39;ll attempt to update a Cash Card with ID <code>99999</code>, which does not exist.</p>
<p>We should expect a generic <code>404 NOT_FOUND</code> error.</p>
</li>
<li><p>Run the tests.</p>
<p>Let&#39;s make a hypothesis about what will happen when we run the tests.</p>
<p>Run the tests and observe the results.</p>
<pre><code class="hljs language-shell">...
CashCardApplicationTests &gt; shouldNotUpdateACashCardThatDoesNotExist() FAILED
 org.opentest4j.AssertionFailedError:
 expected: 404 NOT_FOUND
  but was: 403 FORBIDDEN
</code></pre>
<p>Well that&#39;s...interesting. Why did we get a <code>403 FORBIDDEN</code>?</p>
<p>Before we run them again, let&#39;s edit <code>build.gradle</code> to enable additional test output.</p>
<pre><code class="hljs language-groovy">test {
 testLogging {
     ...
     // Change to `true` for more verbose test output
     showStandardStreams = true
 }
}
</code></pre>
<p>After rerunning the tests, search the output for the following:</p>
<pre><code class="hljs language-shell">CashCardApplicationTests &gt; shouldNotUpdateACashCardThatDoesNotExist() STANDARD_OUT
...
java.lang.NullPointerException: Cannot invoke &quot;example.cashcard.CashCard.id()&quot; because &quot;cashCard&quot; is null
</code></pre>
<p>A <code>NullPointerException</code>! Why a <code>NullPointerException</code>?</p>
<p>Looking at <code>CashCardController.putCashCard</code> we can see that if we don&#39;t find the <code>cashCard</code> then method calls to <code>cashCard</code> will result in a <code>NullPointerException</code>. That makes sense.</p>
<p>But why is a <code>NullPointerException</code> thrown in our Controller resulting in a <code>403 FORBIDDEN</code> instead of a <code>500 INTERNAL_SERVER_ERROR</code>, given the server &quot;crashed?&quot;</p>
<h3 id="learning-moment-spring-security-and-error-handling">Learning Moment: Spring Security and Error Handling</h3>
<p>Our Controller is returning <code>403 FORBIDDEN</code> instead of an <code>500 INTERNAL_SERVER_ERROR</code> because Spring Security is automatically implementing a best practice regarding how errors are handled by Spring Web.</p>
<p>It&#39;s important to understand that any information returned from our application might be useful to a bad actor attempting to violate our application&#39;s security. For example: knowledge about actions that causes our application to crash -- a <code>500 INTERNAL_SERVER_ERROR</code>.</p>
<p>In order to avoid &quot;leaking&quot; information about our application, Spring Security has configured Spring Web to return a generic <code>403 FORBIDDEN</code> in most error conditions. If almost everything results in a <code>403 FORBIDDEN</code> response then an attacker doesn&#39;t really know what&#39;s going on.</p>
<p>Now that we understand what is happening, let&#39;s fix it.</p>
</li>
<li><p>Don&#39;t crash.</p>
<p>Though we&#39;re thankful to Spring Security, our application should not crash - we shouldn&#39;t allow our code to throw a <code>NullPointerException</code>. Instead, we should handle the condition when <code>cashCard == null</code>, and return a generic <code>404 NOT_FOUND</code> HTTP response.</p>
<p>Update <code>CashCardController.putCashCard</code> to return <code>404 NOT_FOUND</code> if no existing <code>CashCard</code> is found.</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@PutMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">putCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, <span class="hljs-meta">@RequestBody</span> CashCard cashCardUpdate, Principal principal)</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCard</span> <span class="hljs-operator">=</span> cashCardRepository.findByIdAndOwner(requestedId, principal.getName());
    <span class="hljs-keyword">if</span> (cashCard != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">CashCard</span> <span class="hljs-variable">updatedCashCard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CashCard</span>(cashCard.id(), cashCardUpdate.amount(), principal.getName());
        cashCardRepository.save(updatedCashCard);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
    <span class="hljs-keyword">return</span> ResponseEntity.notFound().build();
}
</code></pre>
</li>
<li><p>Run the tests.</p>
<p>Our tests pass now that we&#39;re returning a <code>404</code> when no <code>CashCard</code> is found for this user.</p>
<pre><code class="hljs language-shell">BUILD SUCCESSFUL in 6s
</code></pre>
</li>
</ol>
<hr>
</div


<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-oqvxew" data-session-namespace="spring-academy-w08-s450" data-workshop-namespace="spring-academy-w08" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="04-test-security" data-current-page="05-refactor" data-next-page="10-summary" data-page-format="markdown" data-page-step="5" data-pages-total="6"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="04-test-security" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="10-summary" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">5: Refactor the Controller Code</h1><div class="rendered-content"><p>Let&#39;s reinforce your usage of the Red, Green, Refactor development loop.</p>
<p>We have just completed several tests focused on updating an existing Cash Card.</p>
<p>Do we have any opportunities to simplify, reduce duplication, or otherwise refactor our code without changing behavior?</p>
<p>Continue on to address several refactoring opportunities.</p>
<h3 id="simplify-the-code">Simplify the Code</h3>
<ol>
<li><p>Remove the <code>Optional</code>.</p>
<p>This might be controversial: since we are not taking advantage of features of <code>Optional</code> in <code>CashCardController.findById</code>, and no other Controller methods use an <code>Optional</code>, let&#39;s simplify our code by removing it.</p>
<p>Edit <code>CashCardController.findById</code> to remove the usage of the <code>Optional</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-comment">// remove the unused Optional import if present</span>
<span class="hljs-comment">// import java.util.Optional;</span>

<span class="hljs-meta">@GetMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;CashCard&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, Principal principal)</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCard</span> <span class="hljs-operator">=</span> cashCardRepository.findByIdAndOwner(requestedId, principal.getName());
    <span class="hljs-keyword">if</span> (cashCard != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> ResponseEntity.ok(cashCard);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> ResponseEntity.notFound().build();
    }
}
</code></pre>
</li>
<li><p>Run the tests.</p>
<p>Because we have not changed any functionality, the tests will continue to pass.</p>
<pre><code class="hljs language-shell">./gradlew test
...
BUILD SUCCESSFUL in 6s
</code></pre>
</li>
</ol>
<h3 id="reduce-code-duplication">Reduce Code Duplication</h3>
<p>Note that both <code>CashCardController.findById</code> and <code>CashCardController.putCashCard</code> have nearly identical code that retrieves a target <code>CashCard</code> from the <code>CashCardRepository</code> using information from a <code>CashCard</code> and <code>Principal</code>.</p>
<p>Let&#39;s reduce code duplication by extracting a helper method named <code>findCashCard</code> and utilizing it in both <code>.findById</code> and <code>.putCashCard</code>.</p>
<p>This will allow us to update how we retrieve a <code>CashCard</code> in one place as the Controller changes over time.</p>
<ol>
<li><p>Create a shared <code>findCashCard</code> method.</p>
<p>Create a new <code>private</code> method in <code>CashCardController</code> named <code>findCashCard</code>, using functionality we&#39;ve written before:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">private</span> CashCard <span class="hljs-title function_">findCashCard</span><span class="hljs-params">(Long requestedId, Principal principal)</span> {
    <span class="hljs-keyword">return</span> cashCardRepository.findByIdAndOwner(requestedId, principal.getName());
}
</code></pre>
</li>
<li><p>Update <code>CashCardController.findById</code> and rerun the tests.</p>
<p>Next, utilize the new <code>findCashCard</code> method in <code>CashCardController.findById</code>.</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@GetMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;CashCard&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, Principal principal)</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCard</span> <span class="hljs-operator">=</span> findCashCard(requestedId, principal);
    ...
</code></pre>
<p>No functionality has changed, so no tests should fail when we rerun the tests.</p>
<pre><code class="hljs language-shell">./gradlew test
...
BUILD SUCCESSFUL in 6s
</code></pre>
</li>
<li><p>Update <code>CashCardController.putCashCard</code> and rerun the tests.</p>
<p>Similar to the previous step, utilize the new <code>findCashCard</code> method in <code>CashCardController.putCashCard</code>.</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@PutMapping(&quot;/{requestedId}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">putCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long requestedId, <span class="hljs-meta">@RequestBody</span> CashCard cashCardUpdate, Principal principal)</span> {
    <span class="hljs-type">CashCard</span> <span class="hljs-variable">cashCard</span> <span class="hljs-operator">=</span> findCashCard(requestedId, principal);
    ...
</code></pre>
<p>As with the other refactoring we have performed, no functionality has changed, so no tests should fail when we rerun the tests.</p>
<pre><code class="hljs language-shell">./gradlew test
...
BUILD SUCCESSFUL in 6s
</code></pre>
</li>
</ol>
<p>Look at that! We have refactored our code by simplifying it and also reduced code duplication.</p>
</div>




 <div class="rich-text col-span-2">
                <h1>Implementing DELETE</h1>

                                    
<p>In this lesson, we&rsquo;ll implement the last of the four CRUD operations: Delete! By now, you should be familiar with what question we should ask first: What is the API&rsquo;s data specification for the Delete endpoint? The specification includes the details of the Request and Response.</p>
<p>At the risk of spoiling the outcome, this is the specification that we&rsquo;ll define:</p>
<p>Request:</p>
<ul><li>Verb: <code>DELETE</code></li>
<li>URI: <code>/cashcards/{id}</code></li>
<li>Body: <em>(empty)</em></li>
</ul><p>Response:</p>
<ul><li>Status code: <code>204 NO CONTENT</code></li>
<li>Body: <em>(empty)</em></li>
</ul><p>We&rsquo;ll return the <code>204 NO CONTENT</code> status code for a successful delete, but there are additional cases:</p>
<table><thead><tr><th>Response Code</th><th>Use Case</th></tr></thead><tbody><tr><td><code>204 NO CONTENT</code></td><td><ul><li>The record exists, and </li> <li>The Principal is authorized, and </li> <li>The record was successfully deleted. </li> </ul></td></tr><tr><td><code>404 NOT FOUND</code></td><td><ul><li>The record does not exist (a non-existent ID was sent). </li> </ul></td></tr><tr><td><code>404 NOT FOUND</code></td><td><ul><li>The record does exist but the Principal is not the owner. </li> </ul></td></tr></tbody></table><p>Why do we return 404 for the "ID does not exist" and "not authorized to access this ID" cases? In order to not "leak" information: If the API returned different results for the two cases, then an unauthorized user would be able to discover specific IDs that they are not authorized to access.</p>
<h2 id="additional-options" class="anchored"><a href="#additional-options" class="anchor" role="button"></a>Additional Options</h2>
<p>Let&rsquo;s dig deeper into some more options we'll consider when implementing a Delete operation.</p>
<h3>Hard and Soft Delete</h3>
<p>So what does it mean to delete a Cash Card from a database&rsquo;s point of view? Similar to how we decided that our Update operation means &rdquo;replace the entire existing record&rdquo; (as opposed to supporting partial update), we need to decide what happens to resources when they are deleted.</p>
<p>A simple option, called <strong>hard delete</strong>, is to delete the record from the database. With a hard delete, it&rsquo;s gone forever. So what can we do if we need data that existed prior to its deletion?</p>
<p>An alternative is <strong>soft delete</strong> which works by marking records as "deleted" in the database (so that they are retained, but marked as deleted). For example, we can introduce an <code>IS_DELETED</code> boolean or a <code>DELETED_DATE</code> timestamp column and then set that value-instead of fully removing the record by deleting the database row(s). With a soft delete, we also need to change how Repositories interact with the database. For example, a repository needs to respect the &ldquo;deleted&rdquo; column and exclude records marked deleted from Read requests.</p>
<h2 id="audit-trail-and-archiving" class="anchored"><a href="#audit-trail-and-archiving" class="anchor" role="button"></a>Audit Trail and Archiving</h2>
<p>When working with databases, you&rsquo;ll find that there&rsquo;s often a requirement to keep a record of modifications to data records. For example:</p>
<ul><li>A customer service representative might need to know <em>when</em> a customer deleted their Cash Card.</li>
<li>There may be data retention compliance regulations which require deleted data to be retained for a certain period of time.</li>
</ul><p>If the Cash Card is hard-deleted then we would need to store additional data to be able to answer this question. Let&rsquo;s discuss some ways to record historical information:</p>
<ul><li><strong>Archive</strong> (move) the deleted data into a different location.</li>
<li>Add <strong>audit fields</strong> to the record itself. For example, the <code>DELETED_DATE</code> column that we mentioned already. Additional audit fields can be added, for example <code>DELETED_BY_USER</code>. Again, this is not limited to Delete operations, but Create and Update also.</li>
</ul><p>APIs which implement soft delete and audit fields can return the state of the object in the response, and the <code>200 OK</code> status code. So why did we choose to use 204 instead of 200? Because the <code>204 NO CONTENT</code> status implies that there is no body in the response.</p>
<ul><li>Maintain an <strong>audit trail</strong>. The audit trail is a record of all important operations done to a record. It can contain not only Delete operations, but Create and Update as well.</li>
</ul><p>The advantage of an audit trail over audit fields is that a trail records all events, whereas audit fields on the record capture only the most recent operation. An audit trail can be stored in a different database location, or even in log files.</p>
<p>It&rsquo;s worth mentioning that a combination of several of the above strategies is possible. Here are some examples:</p>
<ul><li>We could implement soft delete, and then have a separate process which hard-deletes or archives soft-deleted records after a certain time period, like once per year.</li>
<li>We could implement hard delete, and archive the deleted records.</li>
<li>In any of the above cases, we could keep an audit log of which operations happened when.</li>
</ul><p>Finally, observe that even the simple specification that we&rsquo;ve chosen doesn&rsquo;t determine whether we implement hard or soft delete. It also doesn&rsquo;t determine whether we add audit fields or keep an audit trail. However, the fact that we chose to return <code>204 NO CONTENT</code> implies that soft-delete is not happening, since if it was, we&rsquo;d probably choose to return <code>200 OK</code> with the record in the body.</p>



 <div class="rich-text col-span-2">
                <h1>Implementing DELETE</h1>

                                    
<p>In this lesson, we&rsquo;ll implement the last of the four CRUD operations: Delete! By now, you should be familiar with what question we should ask first: What is the API&rsquo;s data specification for the Delete endpoint? The specification includes the details of the Request and Response.</p>
<p>At the risk of spoiling the outcome, this is the specification that we&rsquo;ll define:</p>
<p>Request:</p>
<ul><li>Verb: <code>DELETE</code></li>
<li>URI: <code>/cashcards/{id}</code></li>
<li>Body: <em>(empty)</em></li>
</ul><p>Response:</p>
<ul><li>Status code: <code>204 NO CONTENT</code></li>
<li>Body: <em>(empty)</em></li>
</ul><p>We&rsquo;ll return the <code>204 NO CONTENT</code> status code for a successful delete, but there are additional cases:</p>
<table><thead><tr><th>Response Code</th><th>Use Case</th></tr></thead><tbody><tr><td><code>204 NO CONTENT</code></td><td><ul><li>The record exists, and </li> <li>The Principal is authorized, and </li> <li>The record was successfully deleted. </li> </ul></td></tr><tr><td><code>404 NOT FOUND</code></td><td><ul><li>The record does not exist (a non-existent ID was sent). </li> </ul></td></tr><tr><td><code>404 NOT FOUND</code></td><td><ul><li>The record does exist but the Principal is not the owner. </li> </ul></td></tr></tbody></table><p>Why do we return 404 for the "ID does not exist" and "not authorized to access this ID" cases? In order to not "leak" information: If the API returned different results for the two cases, then an unauthorized user would be able to discover specific IDs that they are not authorized to access.</p>
<h2 id="additional-options" class="anchored"><a href="#additional-options" class="anchor" role="button"></a>Additional Options</h2>
<p>Let&rsquo;s dig deeper into some more options we'll consider when implementing a Delete operation.</p>
<h3>Hard and Soft Delete</h3>
<p>So what does it mean to delete a Cash Card from a database&rsquo;s point of view? Similar to how we decided that our Update operation means &rdquo;replace the entire existing record&rdquo; (as opposed to supporting partial update), we need to decide what happens to resources when they are deleted.</p>
<p>A simple option, called <strong>hard delete</strong>, is to delete the record from the database. With a hard delete, it&rsquo;s gone forever. So what can we do if we need data that existed prior to its deletion?</p>
<p>An alternative is <strong>soft delete</strong> which works by marking records as "deleted" in the database (so that they are retained, but marked as deleted). For example, we can introduce an <code>IS_DELETED</code> boolean or a <code>DELETED_DATE</code> timestamp column and then set that value-instead of fully removing the record by deleting the database row(s). With a soft delete, we also need to change how Repositories interact with the database. For example, a repository needs to respect the &ldquo;deleted&rdquo; column and exclude records marked deleted from Read requests.</p>
<h2 id="audit-trail-and-archiving" class="anchored"><a href="#audit-trail-and-archiving" class="anchor" role="button"></a>Audit Trail and Archiving</h2>
<p>When working with databases, you&rsquo;ll find that there&rsquo;s often a requirement to keep a record of modifications to data records. For example:</p>
<ul><li>A customer service representative might need to know <em>when</em> a customer deleted their Cash Card.</li>
<li>There may be data retention compliance regulations which require deleted data to be retained for a certain period of time.</li>
</ul><p>If the Cash Card is hard-deleted then we would need to store additional data to be able to answer this question. Let&rsquo;s discuss some ways to record historical information:</p>
<ul><li><strong>Archive</strong> (move) the deleted data into a different location.</li>
<li>Add <strong>audit fields</strong> to the record itself. For example, the <code>DELETED_DATE</code> column that we mentioned already. Additional audit fields can be added, for example <code>DELETED_BY_USER</code>. Again, this is not limited to Delete operations, but Create and Update also.</li>
</ul><p>APIs which implement soft delete and audit fields can return the state of the object in the response, and the <code>200 OK</code> status code. So why did we choose to use 204 instead of 200? Because the <code>204 NO CONTENT</code> status implies that there is no body in the response.</p>
<ul><li>Maintain an <strong>audit trail</strong>. The audit trail is a record of all important operations done to a record. It can contain not only Delete operations, but Create and Update as well.</li>
</ul><p>The advantage of an audit trail over audit fields is that a trail records all events, whereas audit fields on the record capture only the most recent operation. An audit trail can be stored in a different database location, or even in log files.</p>
<p>It&rsquo;s worth mentioning that a combination of several of the above strategies is possible. Here are some examples:</p>
<ul><li>We could implement soft delete, and then have a separate process which hard-deletes or archives soft-deleted records after a certain time period, like once per year.</li>
<li>We could implement hard delete, and archive the deleted records.</li>
<li>In any of the above cases, we could keep an audit log of which operations happened when.</li>
</ul><p>Finally, observe that even the simple specification that we&rsquo;ve chosen doesn&rsquo;t determine whether we implement hard or soft delete. It also doesn&rsquo;t determine whether we add audit fields or keep an audit trail. However, the fact that we chose to return <code>204 NO CONTENT</code> implies that soft-delete is not happening, since if it was, we&rsquo;d probably choose to return <code>200 OK</code> with the record in the body.</p>




<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="01-overview" data-current-page="02-test-happy-path" data-next-page="03-implement-delete" data-page-format="markdown" data-page-step="2" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="01-overview" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="03-implement-delete" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">2: Test the Happy Path</h1><div class="rendered-content"><p>Let&#39;s start with the simplest happy path: successfully deleting a <code>CashCard</code> which exists.</p>
<p>We need the Delete endpoint to return the <code>204 NO CONTENT</code> status code.</p>
<ol>
<li><p>Write the test.</p>
<p>Add the following method to <code>src/test/java/example/cashcard/CashCardApplicationTests.java</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Test</span>
<span class="hljs-meta">@DirtiesContext</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldDeleteAnExistingCashCard</span><span class="hljs-params">()</span> {
    ResponseEntity&lt;Void&gt; response = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .exchange(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, HttpMethod.DELETE, <span class="hljs-literal">null</span>, Void.class);
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);
}
</code></pre>
<p>Notice that we&#39;ve added the <code>@DirtiesContext</code> annotation. We&#39;ll add this annotation to all tests which change the data. If we don&#39;t, then these tests could affect the result of other tests in the file.</p>
<h3 id="why-not-use-resttemplatedelete">Why not use <code>RestTemplate.delete()</code>?</h3>
<p>Notice that we&#39;re using <code>RestTemplate.exchange()</code> even though <code>RestTemplate</code> supplies a method that looks like we could use: <code>RestTemplate.delete()</code>. However, let&#39;s look at the signature:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestTemplate</span> ... {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String url, Object... uriVariables)</span>
</code></pre>
<p>The other methods we&#39;ve been using (such as <code>getForEntity()</code> and <code>exchange()</code>) return a <code>ResponseEntity</code>, but <code>delete()</code> does not. Instead, it&#39;s a <code>void</code> method. Why is this?</p>
<p>The Spring Web framework supplies the <code>delete()</code> method as a convenience, but it comes with some assumptions:</p>
<ol>
<li>A response to a <code>DELETE</code> request will have no body.</li>
<li>The client shouldn&#39;t care what the response code is unless it&#39;s an error, in which case, it&#39;ll throw an exception.</li>
</ol>
<p>Given those assumptions, no return value is needed from <code>delete()</code>.</p>
<p>But the second assumption makes <code>delete()</code> unsuitable for us: We need the <code>ResponseEntity</code> in order to assert on the status code! So we won&#39;t use the convenience method, but rather let&#39;s use the more general method: <code>exchange()</code>.</p>
</li>
<li><p>Run the tests.</p>
<p>As always, we use <code>./gradlew test</code> to run the tests.</p>
<pre><code class="hljs language-console">[~/exercises] $ ./gradlew test
...
CashCardApplicationTests &gt; shouldDeleteAnExistingCashcard() FAILED
    org.opentest4j.AssertionFailedError:
    expected: 204 NO_CONTENT
    but was: 403 FORBIDDEN
</code></pre>
<p>The test failed because the <code>DELETE /cashcards/99</code> request returned a <code>403 FORBIDDEN</code>.</p>
<p>At this point you probably expected this result: Spring Security returns a <code>403</code> response for any endpoint which is not mapped.</p>
<p>We need to implement the Controller method! So let&#39;s do it.</p>
</li>
<li><p>Implement the Delete endpoint in the Controller.</p>
<p>Add the following method to the <code>CashCardController</code> class:</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@DeleteMapping(&quot;/{id}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
}
</code></pre>
<p>Run the tests. They pass!</p>
<p>So are we done? Not yet!</p>
<p>We haven&#39;t written the code to actually <em>delete</em> the item. Let&#39;s do that next.</p>
<p>We write the test first, of course.</p>
</li>
<li><p>Test that we&#39;re actually deleting the <code>CashCard</code>.</p>
<p>Add the following assertions to the <code>shouldDeleteAnExistingCashcard()</code> method:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldDeleteAnExistingCashCard</span><span class="hljs-params">()</span> {
    ResponseEntity&lt;Void&gt; response = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .exchange(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, HttpMethod.DELETE, <span class="hljs-literal">null</span>, Void.class);
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

    <span class="hljs-comment">// Add the following code:</span>
    ResponseEntity&lt;String&gt; getResponse = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .getForEntity(<span class="hljs-string">&quot;/cashcards/99&quot;</span>, String.class);
    assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
}
</code></pre>
</li>
<li><p>Understand the test code.</p>
<p>We want to test that the deleted Cash Card is actually deleted, so we try to <code>GET</code> it, and assert that the result code is <code>404 NOT FOUND</code>.</p>
<p>Run the test. Does it pass? Of course not!</p>
<pre><code class="hljs language-console">CashCardApplicationTests &gt; shouldDeleteAnExistingCashcard() FAILED
    org.opentest4j.AssertionFailedError:
    expected: 404 NOT_FOUND
    but was: 200 OK
</code></pre>
<p>What do we need to do to make the test pass? Write some code to delete the record!</p>
<p>Let&#39;s go.</p>
</li>
</ol>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="03-implement-delete" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page active"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>




<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="02-test-happy-path" data-current-page="03-implement-delete" data-next-page="04-doesnt-exist" data-page-format="markdown" data-page-step="3" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="02-test-happy-path" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="04-doesnt-exist" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">3: Implement the DELETE Endpoint</h1><div class="rendered-content"><p>Now we need to write a Controller method which will be called when we send a <code>DELETE</code> request with the proper URI.</p>
<ol>
<li><p>Add code to the Controller to delete the record.</p>
<p>Change the <code>CashCardController.deleteCashCard()</code> method:</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@DeleteMapping(&quot;/{id}&quot;)</span>
<span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteCashCard</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    cashCardRepository.deleteById(id); <span class="hljs-comment">// Add this line</span>
    <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
}
</code></pre>
<p>The change is straightforward: </p>
<ul>
<li>We use the <code>@DeleteMapping</code> with the <code>&quot;{id}&quot;</code> parameter, which Spring Web matches to the <code>id</code> method parameter.</li>
<li><code>CashCardRepository</code> already has the method we need: <code>deleteById()</code> (it&#39;s inherited from <code>CrudRepository</code>).</li>
</ul>
<p>Run the tests, and watch them pass!</p>
</li>
</ol>
<p>Great, what to do next?</p>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="04-doesnt-exist" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page active"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>




<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="03-implement-delete" data-current-page="04-doesnt-exist" data-next-page="05-enforce-ownership" data-page-format="markdown" data-page-step="4" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="03-implement-delete" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="05-enforce-ownership" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">4: Test case: The Cash Card doesn't exist</h1><div class="rendered-content"><p>Our contract states that we should return <code>404 NOT FOUND</code> if we try to delete a card that doesn&#39;t exist.</p>
<ol>
<li><p>Write the test.</p>
<p>Add the following test method to <code>CashCardApplicationTests</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldNotDeleteACashCardThatDoesNotExist</span><span class="hljs-params">()</span> {
    ResponseEntity&lt;Void&gt; deleteResponse = restTemplate
            .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
            .exchange(<span class="hljs-string">&quot;/cashcards/99999&quot;</span>, HttpMethod.DELETE, <span class="hljs-literal">null</span>, Void.class);
    assertThat(deleteResponse.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
}
</code></pre>
</li>
<li><p>Run the tests.</p>
<pre><code class="hljs language-console">CashCardApplicationTests &gt; shouldNotDeleteACashCardThatDoesNotExist() FAILED
    org.opentest4j.AssertionFailedError:
    expected: 404 NOT_FOUND
    but was: 204 NO_CONTENT
</code></pre>
<p>No surprise here&mdash;we need to enforce the security of our app by checking that the user trying to delete a card is the owner. Spring Security does a lot of things for us, but this is not one of them.</p>
</li>
</ol>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="05-enforce-ownership" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page active"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>



<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="04-doesnt-exist" data-current-page="05-enforce-ownership" data-next-page="06-refactor" data-page-format="markdown" data-page-step="5" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="04-doesnt-exist" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="06-refactor" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">5: Enforce Ownership</h1><div class="rendered-content"><p>We need to check whether the record exists. If not, we should <em>not</em> delete the Cash Card, and return <code>404 NOT FOUND</code>.</p>
<ol>
<li><p>Make the following changes to <code>CashCardController.deleteCashCard</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">private</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteCashCard</span><span class="hljs-params">(
        <span class="hljs-meta">@PathVariable</span> Long id,
        Principal principal // Add Principal to the parameter list
    )</span> {
    <span class="hljs-comment">// Add the following 3 lines:</span>
    <span class="hljs-keyword">if</span> (!cashCardRepository.existsByIdAndOwner(id, principal.getName())) {
        <span class="hljs-keyword">return</span> ResponseEntity.notFound().build();
    }
...
}
</code></pre>
<p>Let&#39;s be sure to the add the <code>Principal</code> parameter!</p>
<p>We&#39;re using the Principal in order to check whether the Cash Card exists, <em>and</em> at the same time, enforce ownership.</p>
</li>
<li><p>Add the <code>existsByIdAndOwner()</code> method to the Repository.</p>
<p>Also, let&#39;s add the new method <code>existsByIdAndOwner()</code> to <code>CashCardRepository</code>:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CashCardRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CrudRepository</span>&lt;CashCard, Long&gt;, PagingAndSortingRepository&lt;CashCard, Long&gt; {
    ...
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">existsByIdAndOwner</span><span class="hljs-params">(Long id, String owner)</span>;
    ...
}
</code></pre>
</li>
<li><p>Understand the Repository code.</p>
<p>We added logic to the Controller method to check whether the Cash Card ID in the request actually exists in the database. The method we&#39;ll use is <code>CashCardRepository.existsByIdAndOwner(id, username)</code>.</p>
<p>This is another case where Spring Data will generate the implementation of this method as long as we add it to the Repository.</p>
<p>So why not just use the <code>findByIdAndOwner()</code> method and check whether it returns <code>null</code>? We could absolutely do that! But, such a call would return extra information (the content of the Cash Card retrieved), so we&#39;d like to avoid it as to not introduce extra complexity.</p>
<p>If you&#39;d rather not use the <code>existsByIdAndOwner()</code> method, that&#39;s ok! You may choose to use <code>findByIdAndOwner()</code>. The test result will be the same!</p>
</li>
<li><p>Watch the test pass.</p>
<p>Let&#39;s run the test and, no big surprise, the test passes!</p>
<pre><code class="hljs language-shell">[~/exercises] $ ./gradlew test
...
BUILD SUCCESSFUL in 8s
</code></pre>
</li>
</ol>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="06-refactor" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page active"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>




<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="05-enforce-ownership" data-current-page="06-refactor" data-next-page="07-hide-unauthorized" data-page-format="markdown" data-page-step="6" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="05-enforce-ownership" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="07-hide-unauthorized" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">6: Refactor</h1><div class="rendered-content"><p>At this point, we have an opportunity to practice the <em>Red, Green, Refactor</em> process. We&#39;ve already done <em>Red</em> (the failing test), and <em>Green</em> (the passing test). Now we can ask ourselves, should we <em>Refactor</em> anything?</p>
<p>Here&#39;s the body of our <code>CashCardController.deleteCashCard</code> method:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">if</span> (!cashCardRepository.existsByIdAndOwner(id, principal.getName())) {
    <span class="hljs-keyword">return</span> ResponseEntity.notFound().build();
}
cashCardRepository.deleteById(id);
<span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
</code></pre>
<p>You might find the following version, which is logically equivalent but slightly simpler, to be easier to read:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">if</span> (cashCardRepository.existsByIdAndOwner(id, principal.getName())) {
    cashCardRepository.deleteById(id);
    <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
}
<span class="hljs-keyword">return</span> ResponseEntity.notFound().build();
</code></pre>
<p>The differences are slight, but removing a not-operator (<code>!</code>) from an <code>if</code> statement often makes for easier-to-read code, and <em>readability is important</em>! </p>
<p>If you do find the second version easier to read and understand, then replace the existing code with the new version.</p>
<p>Run the tests again. They still pass!</p>
<pre><code class="hljs language-shell">[~/exercises] $ ./gradlew test
...
BUILD SUCCESSFUL in 8s
</code></pre>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="07-hide-unauthorized" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page active"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>



<!DOCTYPE html><html><head><link rel="stylesheet" href="/workshop/static/bootstrap/css/bootstrap.css"><link rel="stylesheet" href="/workshop/static/fontawesome/css/all.min.css"><link rel="stylesheet" href="/workshop/static/highlight.js/styles/default.css"><link rel="stylesheet" href="/workshop/static/styles/educates.css"><link rel="stylesheet" href="/workshop/static/styles/educates-markdown.css"><link rel="stylesheet" href="/workshop/static/theme/workshop-instructions.css"><link rel="shortcut icon" href="/workshop/static/images/favicon.ico"></head><body data-google-tracking-id="" data-clarity-tracking-id="" data-amplitude-tracking-id="" data-workshop-name="course-spring-brasb-bv8n4j" data-session-namespace="spring-academy-w09-s428" data-workshop-namespace="spring-academy-w09" data-training-portal="spring-academy" data-ingress-domain="acad-spr-prd3.labs.spring.academy" data-ingress-protocol="https" data-ingress-port-suffix="" data-prev-page="06-refactor" data-current-page="07-hide-unauthorized" data-next-page="08-summary" data-page-format="markdown" data-page-step="7" data-pages-total="8"><div class="header page-navbar sticky-top bg-primary"><div class="row row-no-gutters"><div class="col-sm-12"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" type="button" data-goto-page="/" aria-label="Home"><span class="fas fa-home fa-inverse" aria-hidden="true"></span></button></div><div class="btn-toolbar float-right" role="toolbar"><div class="btn-group btn-group-sm" role="group"><button class="btn btn-transparent" id="header-prev-page" type="button" data-goto-page="06-refactor" disabled="" aria-label="Prev"><span class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC" data-toggle="modal" data-target="#table-of-contents"><span class="fas fa-list fa-inverse" aria-hidden="true"></span></button><button class="btn btn-transparent" id="header-next-page" type="button" data-goto-page="08-summary" disabled="" aria-label="Next"><span class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button></div></div></div></div></div><div class="container-fluid main-content"><div class="row"><div class="col-sm-12"><section class="page-content"><h1 class="title">7: Hide Unauthorized Records</h1><div class="rendered-content"><p>At this point, you may ask yourself, &quot;Are we done?&quot; You are the best person to answer that question! If you want, take a couple minutes to refresh yourself with the accompanying lesson in order to see if we&#39;ve tested and implemented every aspect of the API contract for DELETE.</p>
<p>OK, that was time well-spent, wasn&#39;t it? That&#39;s right - There is one more case that we have yet to test: What if the user attempts to delete a Cash Card owned by someone else? We decided in the associated lesson that the response should be <code>404 NOT FOUND</code> in this case. Thats enough information for us to write a test for that case:</p>
<ol>
<li><p>In <code>CashCardApplicationTests.java</code>, add the following test method at the end of the class:</p>
<pre><code class="hljs language-java">    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldNotAllowDeletionOfCashCardsTheyDoNotOwn</span><span class="hljs-params">()</span> {
        ResponseEntity&lt;Void&gt; deleteResponse = restTemplate
                .withBasicAuth(<span class="hljs-string">&quot;sarah1&quot;</span>, <span class="hljs-string">&quot;abc123&quot;</span>)
                .exchange(<span class="hljs-string">&quot;/cashcards/102&quot;</span>, HttpMethod.DELETE, <span class="hljs-literal">null</span>, Void.class);
        assertThat(deleteResponse.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
    }
</code></pre>
</li>
<li><p>Run the test</p>
<p>Do you think the test will pass? Take a moment to predict the outcome, then run the test.</p>
<p>It passed! That&#39;s great news.</p>
<ul>
<li>We have written a test for a specific case in our API.</li>
<li>The test passed without any code changes!</li>
</ul>
<p>Now let&#39;s consider a question which may have occurred to you: Why do I need that test, since it passes without having to make any code changes? Isn&#39;t the purpose of TDD to use tests to guide the implementation of the application? If that&#39;s the case, why did I bother to write that test?</p>
<p>Answers:</p>
<ul>
<li>Yes, that is <em>one</em> of many benefits that TDD provides: A process to guide the creation of code in order to arrive at a desired outcome.</li>
<li>Tests themselves, though, have another purpose, separate from TDD: Tests are a powerful safety net to enforce correctness. Since the test you just wrote tests a different case than those already written, it provides value. If someone were to make a code change which caused this new test to fail, then you will have caught the error before it became an issue! Yay for Tests.</li>
</ul>
</li>
<li><p>One More Test</p>
<p>But wait, you say. Shouldn&#39;t I test that the record that I tried to delete still exists in the database - that it didn&#39;t get deleted?
Yes! That is a valid test. Thanks for mentioning it! Add the following code to the test method, to verify that the record you tried unsuccessfully to delete is still there:</p>
<pre><code class="hljs language-java">    <span class="hljs-keyword">void</span> <span class="hljs-title function_">shouldNotAllowDeletionOfCashCardsTheyDoNotOwn</span><span class="hljs-params">()</span> {
...
        <span class="hljs-comment">// Add this code at the end of the test method:</span>
        ResponseEntity&lt;String&gt; getResponse = restTemplate
                .withBasicAuth(<span class="hljs-string">&quot;kumar2&quot;</span>, <span class="hljs-string">&quot;xyz789&quot;</span>)
                .getForEntity(<span class="hljs-string">&quot;/cashcards/102&quot;</span>, String.class);
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
    }
</code></pre>
<p>Do you think the test will pass? Of course it will! (right?)</p>
</li>
<li><p>Run the test</p>
<p>Just to make sure ... Please run all the tests and ensure that they pass.</p>
</li>
</ol>
</div><div class="page-meta clearfix"><button class="btn btn-lg btn-primary float-right" id="next-page" type="button" data-next-page="08-summary" data-restart-url="https://spring-academy-ui.acad-spr-prd3.labs.spring.academy/workshops/session/spring-academy-w09-s428/delete/" aria-label="Continue">Continue</button></div></section></div></div></div><div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title" aria-hidden="true"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 id="table-of-contents-title">Lesson</h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><ul class="menu"><li class="category"><ul class="modules"><li class="page"><a href="/workshop/content/01-overview">1: Overview</a></li><li class="page"><a href="/workshop/content/02-test-happy-path">2: Test the Happy Path</a></li><li class="page"><a href="/workshop/content/03-implement-delete">3: Implement the DELETE Endpoint</a></li><li class="page"><a href="/workshop/content/04-doesnt-exist">4: Test case: The Cash Card doesn't exist</a></li><li class="page"><a href="/workshop/content/05-enforce-ownership">5: Enforce Ownership</a></li><li class="page"><a href="/workshop/content/06-refactor">6: Refactor</a></li><li class="page active"><a href="/workshop/content/07-hide-unauthorized">7: Hide Unauthorized Records</a></li><li class="page"><a href="/workshop/content/08-summary">8: Summary</a></li></ul></li></ul></div><div class="modal-footer"><button class="btn btn-primary" type="button" data-dismiss="modal">Close</button></div></div></div></div><div class="modal fade" id="preview-image-dialog" role="dialog"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="preview-image-title"></h5><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body preview-image-body"><img class="img-fluid" id="preview-image-element"></div><div class="modal-footer"><button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button></div></div></div></div><script src="/workshop/static/scripts/educates-bundle.min.js"></script><script src="/workshop/static/theme/workshop-instructions.js"></script></body></html>














